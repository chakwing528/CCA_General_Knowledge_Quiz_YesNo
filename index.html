<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸¸è­˜å•ç­”æ¯”è³½ç³»çµ± -å°éŒ¯- V11</title>
    <style>
        :root {
            --setup-color: #d35400; --admin-color: #2980b9; --game-color: #27ae60;
            --bg: #f8f9fa; --dark: #1e272e; --error: #c0392b; --success: #27ae60; --gold: #f1c40f;
        }
        body { font-family: 'PingFang HK', 'Helvetica Neue', Arial, sans-serif; margin: 0; background: #fff; color: var(--dark); overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        .content-section { display: none; width: 100%; flex-grow: 1; overflow-y: auto; box-sizing: border-box; }
        .content-section.active { display: flex; flex-direction: column; }

        .admin-container { padding: 30px; max-width: 1200px; margin: auto; width: 95%; }
        .admin-box { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); margin-bottom: 25px; border: 1px solid #eee; }
        input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #dfe6e9; border-radius: 8px; box-sizing: border-box; font-size: 16px; }

        .scoreboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0; margin: 0; width: 100%; flex-shrink: 0; transition: 0.5s; }
        .scoreboard.has-winner .team-card:not(.winner-active), .team-card.already-tried:not(.winner-active) { filter: brightness(0.2) grayscale(0.8) !important; opacity: 0.4 !important; box-shadow: none !important; }

        .team-card { 
            height: 350px; position: relative; overflow: hidden; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.9); 
            background-size: cover; background-position: center; background-color: #57606f; transition: 0.4s;
        }
        .winner-active { box-shadow: inset 0 0 100px var(--gold); animation: blink-gold 0.8s infinite; z-index: 5; transform: scale(1.02); filter: none !important; opacity: 1 !important; }
        @keyframes blink-gold { 0%, 100% { background-color: rgba(249, 202, 36, 0.2); } 50% { background-color: rgba(249, 202, 36, 0.6); } }
        
        .team-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.3); z-index: 1; }
        .team-content { z-index: 2; text-align: center; }
        .team-name-label { font-size: 45px; font-weight: 900; margin-bottom: 10px; text-transform: uppercase; }
        .score-val { font-size: 120px; font-weight: 900; line-height: 1; }

        .display-area { background: white; width: 100%; flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; border-top: 1px solid #ddd; position: relative; padding-bottom: 80px; }
        .q-badge { position: absolute; bottom: 20px; right: 20px; background: #57606f; color: white; padding: 8px 25px; border-radius: 30px; font-size: 16px; font-weight: bold; z-index: 5; }
        
        #standby-overlay {
            position: absolute; inset: 0; z-index: 100; 
            background-color: #1e272e; background-size: cover; background-position: center;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; transition: 0.5s;
        }
        #standby-overlay h1 { font-size: 80px; text-shadow: 0 5px 20px rgba(0,0,0,0.5); text-align: center; max-width: 90%; }

        #timer-display { 
            position: absolute; right: 5%; top: 15%; transform: translateY(-50%); 
            font-size: 100px; font-weight: 900; color: var(--error); 
            display: none; animation: pulse-timer 1s infinite; z-index: 20; 
            text-shadow: 0 0 20px rgba(255,255,255,1), 0 5px 15px rgba(0,0,0,0.5);
        }
        @keyframes pulse-timer { 0% { transform: translateY(-50%) scale(1); } 50% { transform: translateY(-50%) scale(1.1); } 100% { transform: translateY(-50%) scale(1); } }

        .judge-grid { display: flex; gap: 30px; width: 90%; max-width: 800px; justify-content: center; transition: 0.3s; }
        .judge-grid.locked { pointer-events: none; opacity: 0.2; filter: grayscale(1); }

        .judge-btn { flex: 1; height: 140px; font-size: 50px; border-radius: 20px; cursor: pointer; font-weight: 900; color: white; border: none; transition: 0.3s; box-shadow: 0 8px 25px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .btn-correct { background: var(--success); }
        .btn-correct:hover { background: #219150; transform: translateY(-3px); }
        .btn-wrong { background: var(--error); }
        .btn-wrong:hover { background: #a93226; transform: translateY(-3px); }
        .judge-btn small { font-size: 18px; opacity: 0.8; margin-top: 5px; }

        .controls { background: #1e272e; padding: 0 15px; display: flex; justify-content: space-between; align-items: center; z-index: 200; height: 75px; min-height: 75px; max-height: 75px; box-sizing: border-box; border-top: 1px solid #333; width: 100%; flex-shrink: 0; }
        .controls-left { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
        .controls-right { display: flex; align-items: center; gap: 6px; flex-grow: 1; justify-content: flex-end; margin-left: 10px; }
        .version-label { color: rgba(255, 255, 255, 0.5); font-size: 14px; font-weight: 900; white-space: nowrap; margin-right: 10px; }

        .tab-group { display: flex; background: #2f3542; border-radius: 8px; padding: 3px; gap: 3px; }
        .nav-btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; color: white; font-size: 14px; font-weight: bold; background: transparent; white-space: nowrap; transition: 0.2s; }
        .nav-btn.active { background: #57606f; }
        .ctrl-btn { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; color: white; background: #485460; font-weight: bold; font-size: 13px; height: 38px; white-space: nowrap; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .ctrl-btn:hover { background: #5f6e7c; }

        #buzzer-overlay { position: fixed; inset: 0; z-index: 999; display: none; flex-direction: column; align-items: center; justify-content: center; background-size: cover; background-position: center; background-repeat: no-repeat; }
        .overlay-mask { position: absolute; inset: 0; background: rgba(0,0,0,0.4); z-index: 1; }
        .win-text { font-size: 140px; font-weight: 900; color: var(--gold); position: relative; z-index: 2; text-shadow: 0 5px 20px rgba(0,0,0,0.8); text-transform: uppercase; }
        .win-sub { font-size: 36px; font-weight: bold; position: relative; z-index: 2; color: #fff; margin-top: -10px; text-shadow: 0 2px 5px rgba(0,0,0,0.8); }

        .q-list-item { background: #fdfdfd; padding: 18px; margin-bottom: 12px; border-radius: 12px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .del-btn { background: var(--error); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; }
        .remove-img-btn { background: #7f8c8d; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-left: 5px; }

        .q-points-edit { display: flex; gap: 10px; margin-top: 10px; align-items: center; font-size: 14px; }
        .q-points-edit input { width: 70px !important; padding: 5px !important; margin: 0 !important; height: 30px !important; font-size: 14px !important; }
    </style>
</head>
<body>

<div id="setup" class="content-section">
    <div class="admin-container">
        <div class="admin-box">
            <h2>åƒè³½éšŠä¼è¨­å®š</h2>
            <div id="team-setup-ui" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;"></div>
            <button class="ctrl-btn" style="width:100%; margin-top:30px; height:55px; background:var(--game-color); font-size:18px;" onclick="saveState(); alert('è¨­å®šå·²æˆåŠŸå„²å­˜ï¼')">ç¢ºèªå„²å­˜éšŠä¼è¨­å®š</button>
        </div>
        <div class="admin-box">
            <h3>ç³»çµ±éŸ³æ•ˆèˆ‡å¾…æ©Ÿè¨­å®š</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:30px;">
                <div><label>ğŸŸ¢ æ­£ç¢ºéŸ³æ•ˆ</label><input type="file" accept="audio/*" onchange="loadAudio(event, 'correct')"></div>
                <div><label>ğŸ”´ éŒ¯èª¤éŸ³æ•ˆ</label><input type="file" accept="audio/*" onchange="loadAudio(event, 'wrong')"></div>
                <div><label>ğŸ”” æ¶ç­”æˆåŠŸéŸ³æ•ˆ</label><input type="file" accept="audio/*" onchange="loadAudio(event, 'buzzer')"></div>
                <div><label>ğŸµ å¾…æ©ŸèƒŒæ™¯éŸ³æ¨‚</label><input type="file" accept="audio/*" onchange="loadAudio(event, 'standby_music')"></div>
                <div><label>ğŸ–¼ï¸ å¾…æ©Ÿç•«é¢åœ–ç‰‡</label><input type="file" accept="image/*" onchange="loadStandbyImg(event)"></div>
                <div><label>âœï¸ å¾…æ©Ÿç•«é¢å­—çœ¼</label><input type="text" id="standby-text-input" placeholder="ä¾‹å¦‚ï¼šæ¯”è³½å³å°‡é–‹å§‹" onchange="standbyText=this.value; saveState()"></div>
            </div>
        </div>
    </div>
</div>

<div id="admin" class="content-section">
    <div class="admin-container">
        <div class="admin-box">
            <h3>âš™ï¸ æ¯”è³½è¦å‰‡è¨­å®š</h3>
            <div style="display:flex; gap:15px; align-items:center;">
                <label>âš¡ æ¶ç­”æ™‚é™(ç§’): <input type="number" id="time-toss" value="20" style="width:60px;" onchange="saveState()"></label>
                <label>ğŸ“ å¿…ç­”æ™‚é™(ç§’): <input type="number" id="time-comp" value="30" style="width:60px;" onchange="saveState()"></label>
            </div>
        </div>
        <div class="admin-box">
            <h2>é¡Œç›®ç®¡ç†</h2>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="ctrl-btn" style="background:var(--admin-color); flex:1" onclick="downloadQsOnly()">â¬‡ï¸ åŒ¯å‡ºå‚™ä»½</button>
                <button class="ctrl-btn" style="background:#8e44ad; flex:1" onclick="document.getElementById('file-in').click()">â¬†ï¸ åŒ¯å…¥é¡Œç›®</button>
                <input type="file" id="file-in" style="display:none" onchange="uploadQs(event)">
            </div>
            <hr>
            <h3>æ–°å¢é¡Œç›®ç´€éŒ„</h3>
            <textarea id="q-input-text" placeholder="è«‹åœ¨æ­¤è¼¸å…¥é¡Œç›®å…§å®¹..." rows="3" style="font-size:18px;"></textarea>
            <div style="display:flex; gap:15px;">
                <label>é è¨­çåˆ†: <input type="number" id="pts-win" value="10" style="width:80px;"></label>
                <label>é è¨­ç½°åˆ†: <input type="number" id="pts-lose" value="5" style="width:80px;"></label>
            </div>
            <button class="ctrl-btn" style="width:100%; margin-top:10px; background:var(--admin-color); height:45px;" onclick="addQ()">âœ… å„²å­˜é¡Œç›®</button>
        </div>
        <div class="admin-box"><h3>é¡Œç›®æ¸…å–® (å¯ä¿®æ”¹åˆ†æ•¸)</h3><div id="q-list"></div></div>
    </div>
</div>

<div id="game" class="content-section">
    <div class="scoreboard" id="game-sb"></div>
    <div class="display-area">
        <div id="standby-overlay">
            <h1 id="standby-display-text">æ¯”è³½å³å°‡é–‹å§‹</h1>
            <button class="ctrl-btn" style="height:40px; width:160px; font-size:16px; background:var(--game-color); margin-top:150px; border-radius: 20px;" onclick="toggleStandby(false)">é€²å…¥æ¯”è³½ä»‹é¢</button>
        </div>
        <div id="timer-display">20</div>
        <div class="judge-grid" id="judge-ui">
            <button class="judge-btn btn-correct" onclick="judgeAnswer(true)">âœ… å° <small>Correct</small></button>
            <button class="judge-btn btn-wrong" onclick="judgeAnswer(false)">âŒ éŒ¯ <small>Wrong</small></button>
        </div>
        <div id="g-res"></div>
        <div id="g-badge" class="q-badge">æº–å‚™é–‹å§‹</div>
    </div>
</div>

<div class="controls">
    <div class="controls-left">
        <span class="version-label">-å°éŒ¯- V11</span>
        <div class="tab-group">
            <button class="nav-btn tab-setup" onclick="showTab('setup')">è¨­å®š</button>
            <button class="nav-btn tab-admin" onclick="showTab('admin')">ç®¡ç†</button>
            <button class="nav-btn tab-game" onclick="showTab('game')">æ¯”è³½</button>
        </div>
    </div>
    <div class="controls-right">
        <button id="btn-standby-toggle" class="ctrl-btn" style="background:#8e44ad; margin-right:10px;" onclick="toggleStandby(true)">å¾…æ©Ÿç•«é¢</button>
        <button class="ctrl-btn" onclick="navQ(-1)">ä¸Šé¡Œ</button>
        <button id="btn-next" class="ctrl-btn" onclick="navQ(1)" style="background:var(--admin-color)">ä¸‹é¡Œ</button>
        <button id="btn-ans" class="ctrl-btn" style="background:#34495e" onclick="showAnswer()">åƒè€ƒç­”æ¡ˆ</button>
        <button class="ctrl-btn" id="btn-buzzer" onclick="toggleBuzzer()">æ¶ç­”</button>
        <button class="ctrl-btn" id="btn-comp" onclick="toggleComp()">å¿…ç­”</button>
        <select id="sel-team" class="team-select" onchange="manuallySelect()"><option value="">æŒ‡å®šéšŠä¼...</option><option value="0">T1</option><option value="1">T2</option><option value="2">T3</option><option value="3">T4</option></select>
        <button class="ctrl-btn" onclick="resetRound()">é‡ç½®</button>
        <input type="number" id="pts-box" class="score-input" value="10">
        <button class="ctrl-btn" style="background:var(--error)" onclick="manualAdj(false)">-</button>
        <button class="ctrl-btn" style="background:var(--success)" onclick="manualAdj(true)">+</button>
    </div>
</div>

<div id="buzzer-overlay" onclick="closeOverlay()">
    <div class="overlay-mask"></div>
    <div id="win-name" class="win-text"></div>
    <div id="win-sub" class="win-sub">æ¶ç­”æˆåŠŸï¼</div>
</div>

<script>
    let questions = JSON.parse(localStorage.getItem('qz_qs')) || [];
    let teams = JSON.parse(localStorage.getItem('qz_teams')) || [{name:"",bg:"",score:0},{name:"",bg:"",score:0},{name:"",bg:"",score:0},{name:"",bg:"",score:0}];
    let audioData = { 
        correct: localStorage.getItem('qz_s1') || '', 
        wrong: localStorage.getItem('qz_s2') || '', 
        buzzer: localStorage.getItem('qz_s3') || '', 
        standby_music: localStorage.getItem('qz_s4') || '' 
    };
    let standbyImg = localStorage.getItem('qz_standby_img') || '';
    let standbyText = localStorage.getItem('qz_standby_text') || 'æ¯”è³½å³å°‡é–‹å§‹';
    let timerSettings = JSON.parse(localStorage.getItem('qz_timers')) || { toss: 20, comp: 30 };
    
    let curIdx = parseInt(localStorage.getItem('qz_curIdx')) || -1;
    let winnerIdx = null, buzzerOn = false, compOn = false, answered = false, showTime = false;
    let hasTried = [false, false, false, false];
    let timerInterval, standbyAudioObj = null;

    window.onload = () => { 
        renderSetup(); renderAdmin(); showTab('game'); syncUI(); 
        document.getElementById('time-toss').value = timerSettings.toss;
        document.getElementById('time-comp').value = timerSettings.comp;
        document.getElementById('standby-text-input').value = standbyText;
        if(standbyImg && standbyImg.trim() !== "") document.getElementById('standby-overlay').style.backgroundImage = `url(${standbyImg})`;
        if(questions.length > 0) navQ(0); 
        toggleStandby(true); 
    };

    function saveState() {
        localStorage.setItem('qz_qs', JSON.stringify(questions));
        localStorage.setItem('qz_teams', JSON.stringify(teams));
        localStorage.setItem('qz_curIdx', curIdx);
        localStorage.setItem('qz_s1', audioData.correct);
        localStorage.setItem('qz_s2', audioData.wrong);
        localStorage.setItem('qz_s3', audioData.buzzer);
        localStorage.setItem('qz_s4', audioData.standby_music);
        localStorage.setItem('qz_standby_img', standbyImg);
        localStorage.setItem('qz_standby_text', standbyText);
        localStorage.setItem('qz_timers', JSON.stringify(timerSettings));
    }

    // ä¿®æ­£é» 1: ç¢ºä¿é€²å…¥è¨ˆæ™‚
    function toggleStandby(show) {
        const overlay = document.getElementById('standby-overlay');
        if(show) {
            overlay.style.display = 'flex';
            if(audioData.standby_music) {
                if(!standbyAudioObj) { standbyAudioObj = new Audio(audioData.standby_music); standbyAudioObj.loop = true; }
                else standbyAudioObj.src = audioData.standby_music;
                standbyAudioObj.play();
            }
        } else {
            overlay.style.display = 'none';
            if(standbyAudioObj) standbyAudioObj.pause();
            // ä¿®æ­£ï¼šé€²å…¥æ¯”è³½ä»‹é¢ï¼Œè‹¥å¿…ç­”å‰‡é–‹è¨ˆæ™‚
            if(compOn && winnerIdx !== null && !answered) startTimer(timerSettings.comp);
        }
    }

    function loadStandbyImg(e) {
        const reader = new FileReader();
        reader.onload = (ev) => { standbyImg = ev.target.result; document.getElementById('standby-overlay').style.backgroundImage = `url(${standbyImg})`; saveState(); };
        reader.readAsDataURL(e.target.files[0]);
    }

    function showTab(t) { document.querySelectorAll('.content-section, .nav-btn').forEach(e => e.classList.remove('active')); document.getElementById(t).classList.add('active'); document.querySelector(`.tab-${t}`).classList.add('active'); if(t === 'game') renderGame(); }
    function addQ() { const text = document.getElementById('q-input-text').value.trim(); if (!text) return alert("è«‹è¼¸å…¥å…§å®¹"); questions.push({ type: "Judgement", cat: "compulsory", ptsWin: parseInt(document.getElementById('pts-win').value), ptsLose: parseInt(document.getElementById('pts-lose').value), text, ans: "Judge", fullAns: text, opts: [] }); saveState(); renderAdmin(); document.getElementById('q-input-text').value = ""; alert("é¡Œç›®å„²å­˜æˆåŠŸï¼"); }
    function renderAdmin() { const list = document.getElementById('q-list'); list.innerHTML = questions.map((q, i) => `<div class="q-list-item"><div class="q-content"><div><b>ç¬¬ ${i+1} é¡Œ</b>: ${q.text}</div><div class="q-points-edit">çåˆ†: <input type="number" value="${q.ptsWin}" onchange="questions[${i}].ptsWin=parseInt(this.value); saveState()"> ç½°åˆ†: <input type="number" value="${q.ptsLose}" onchange="questions[${i}].ptsLose=parseInt(this.value); saveState()"></div></div><button class="del-btn" onclick="delQ(${i})">åˆªé™¤</button></div>`).join(''); }
    function delQ(i) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { questions.splice(i,1); saveState(); renderAdmin(); } }
    
    function renderGame() {
        const sb = document.getElementById('game-sb');
        if (winnerIdx !== null) sb.classList.add('has-winner'); else sb.classList.remove('has-winner');
        sb.innerHTML = teams.map((t, i) => {
            const isWinner = (winnerIdx === i);
            const tried = hasTried[i];
            let cls = isWinner ? "winner-active" : "";
            if (tried && !isWinner) cls += " already-tried";
            return `<div class="team-card ${cls}" style="background-image:url('${t.bg}')"><div class="team-overlay"></div><div class="team-content"><div class="team-name-label">${t.name || ""}</div><div class="score-val">${t.score || 0}</div></div></div>`;
        }).join('');
        const sel = document.getElementById('sel-team'); teams.forEach((t, i) => { if(sel.options[i+1]) sel.options[i+1].text = (t.name ? t.name : `T${i+1}`); });
    }

    // ä¿®æ­£é» 1: æ›é¡Œå¿…ç­”è¨ˆæ™‚
    function navQ(dir) { 
        if(questions.length === 0) return; 
        stopTimer(); 
        curIdx = Math.max(0, Math.min(questions.length - 1, curIdx + dir)); 
        showTime = false; answered = false; hasTried = [false, false, false, false]; 
        document.getElementById('judge-ui').classList.remove('locked');
        const q = questions[curIdx]; 
        document.getElementById('g-badge').innerText = `ç¬¬ ${curIdx + 1} é¡Œ | ç+${q.ptsWin} / ç½°-${q.ptsLose}`; 
        document.getElementById('g-res').style.display = 'none'; 
        document.getElementById('pts-box').value = q.ptsWin; 
        if(!compOn) winnerIdx = null; 
        renderGame(); saveState(); 
        if(compOn && winnerIdx !== null && document.getElementById('standby-overlay').style.display === 'none') startTimer(timerSettings.comp);
    }

    function showAnswer() { stopTimer(); if(questions.length > 0) { document.getElementById('g-res').innerText = "åƒè€ƒç­”æ¡ˆ: " + questions[curIdx].fullAns; document.getElementById('g-res').style.display = 'block'; showTime = true; } }

    function judgeAnswer(isCorrect) {
        if(winnerIdx === null) return alert("è«‹å…ˆé¸å®šéšŠä¼æˆ–ç­‰å¾…æ¶ç­”");
        if(answered) return;
        const q = questions[curIdx];
        const tempWinner = winnerIdx;
        hasTried[tempWinner] = true;
        if (isCorrect) {
            answered = true;
            teams[tempWinner].score = (teams[tempWinner].score || 0) + q.ptsWin;
            playSfx('correct');
            stopTimer();
            document.getElementById('judge-ui').classList.add('locked');
        } else {
            teams[tempWinner].score = (teams[tempWinner].score || 0) - q.ptsLose;
            playSfx('wrong');
            if(!compOn) winnerIdx = null; else { answered = true; document.getElementById('judge-ui').classList.add('locked'); }
            stopTimer();
        }
        renderGame(); saveState();
    }

    function manualAdj(plus) { if(winnerIdx === null) return alert("è«‹å…ˆé¸å®šéšŠä¼"); const val = parseInt(document.getElementById('pts-box').value); teams[winnerIdx].score = (teams[winnerIdx].score || 0) + (plus ? val : -val); playSfx(plus ? 'correct' : 'wrong'); renderGame(); saveState(); }
    function upImg(e, i) { const reader = new FileReader(); reader.onload = (ev) => { const img = new Image(); img.onload = () => { const canvas = document.createElement('canvas'); const MAX_W = 800; let w = img.width, h = img.height; if (w > MAX_W) { h *= MAX_W/w; w = MAX_W; } canvas.width = w; canvas.height = h; canvas.getContext('2d').drawImage(img, 0, 0, w, h); teams[i].bg = canvas.toDataURL('image/jpeg', 0.8); saveState(); renderSetup(); }; img.src = ev.target.result; }; reader.readAsDataURL(e.target.files[0]); }
    function removeImg(i) { teams[i].bg = ""; saveState(); renderSetup(); }
    function toggleBuzzer() { compOn = false; buzzerOn = !buzzerOn; if(buzzerOn) winnerIdx = null; stopTimer(); syncUI(); renderGame(); }
    
    // ä¿®æ­£é» 1: åˆ‡æ›å¿…ç­”é–‹å•Ÿè¨ˆæ™‚
    function toggleComp() { 
        buzzerOn = false; compOn = !compOn; 
        if(!compOn) { stopTimer(); }
        else if(winnerIdx !== null && !answered) startTimer(timerSettings.comp);
        syncUI(); renderGame(); 
    }

    function syncUI() { document.getElementById('btn-buzzer').style.background = buzzerOn ? "var(--success)" : "var(--error)"; document.getElementById('btn-comp').style.background = compOn ? "var(--success)" : "var(--error)"; }
    
    // ä¿®æ­£é» 1: æŒ‡å®šéšŠä¼å¿…ç­”è¨ˆæ™‚
    function manuallySelect() { 
        winnerIdx = document.getElementById('sel-team').value === "" ? null : parseInt(document.getElementById('sel-team').value); 
        renderGame(); 
        if(compOn && winnerIdx !== null && !answered && document.getElementById('standby-overlay').style.display === 'none') startTimer(timerSettings.comp); 
    }

    function resetRound() { stopTimer(); if(!compOn) winnerIdx = null; hasTried = [false, false, false, false]; answered = false; document.getElementById('judge-ui').classList.remove('locked'); document.getElementById('buzzer-overlay').style.display = 'none'; renderGame(); }
    function closeOverlay() { document.getElementById('buzzer-overlay').style.display = 'none'; renderGame(); startTimer(timerSettings.toss); }
    function startTimer(seconds) { stopTimer(); let timeLeft = seconds; const display = document.getElementById('timer-display'); display.innerText = timeLeft; display.style.display = 'block'; timerInterval = setInterval(() => { timeLeft--; display.innerText = timeLeft; if(timeLeft <= 0) { clearInterval(timerInterval); display.innerText = "æ™‚é–“åˆ°!"; } }, 1000); }
    function stopTimer() { clearInterval(timerInterval); document.getElementById('timer-display').style.display = 'none'; }
    function loadAudio(e, type) { const reader = new FileReader(); reader.onload = (ev) => { audioData[type] = ev.target.result; saveState(); }; reader.readAsDataURL(e.target.files[0]); }
    function playSfx(type) { if(audioData[type] && audioData[type] !== "") new Audio(audioData[type]).play(); }

    document.addEventListener('keydown', (e) => {
        if (!document.getElementById('game').classList.contains('active')) return;
        const isStandby = document.getElementById('standby-overlay').style.display !== 'none';
        if(e.code === 'Space') { 
            e.preventDefault(); document.activeElement.blur();
            if(isStandby) toggleStandby(false);
            else if(document.getElementById('buzzer-overlay').style.display === 'flex') closeOverlay();
            else navQ(1); 
            return; 
        }
        if(isStandby) return;
        const tid = {'1':0, '2':1, '3':2, '4':3}[e.key]; if(tid === undefined) return;
        if (compOn || showTime) return; 
        if(buzzerOn && winnerIdx === null && !hasTried[tid]) {
            winnerIdx = tid;
            const overlay = document.getElementById('buzzer-overlay'), teamName = teams[winnerIdx].name, winText = document.getElementById('win-name'), winSub = document.getElementById('win-sub');
            if (teamName && teamName.trim() !== "") { winText.innerText = teamName; winSub.innerText = "æ¶ç­”æˆåŠŸï¼"; } else { winText.innerText = "æ¶ç­”æˆåŠŸï¼"; }
            if(teams[winnerIdx].bg) overlay.style.backgroundImage = `url('${teams[winnerIdx].bg}')`;
            overlay.style.display = 'flex'; playSfx('buzzer'); renderGame();
        }
    });

    function renderSetup() { const ui = document.getElementById('team-setup-ui'); ui.innerHTML = teams.map((t, i) => `<div class="admin-box" style="margin:0; padding:15px;"><b>éšŠä¼ ${i+1} åç¨±</b><input type="text" onchange="teams[${i}].name=this.value; saveState()" value="${t.name || ''}"><div style="display:flex; align-items:center; gap:5px;"><input type="file" onchange="upImg(event, ${i})" style="flex:1"><button class="remove-img-btn" onclick="removeImg(${i})">ç§»é™¤åœ–ç‰‡</button></div><div style="height:35px; background:url('${t.bg}') center/cover; margin-top:8px; border-radius:6px; border:1px solid #ddd"></div></div>`).join(''); }
    function downloadQsOnly() { const blob = new Blob([JSON.stringify(questions, null, 2)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='quiz_TF_V11_backup.json'; a.click(); }
    function uploadQs(e) { const r = new FileReader(); r.onload = (ev) => { questions = JSON.parse(ev.target.result); curIdx = 0; saveState(); location.reload(); }; r.readAsText(e.target.files[0]); }
</script>
</body>
</html>
